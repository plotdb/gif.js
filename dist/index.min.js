var GIFWORKER ="!function(){function t(e,i,r){function s(n,a){if(!i[n]){if(!e[n]){var h=\"function\"==typeof require&&require;if(!a&&h)return h(n,!0);if(o)return o(n,!0);var l=new Error(\"Cannot find module '\"+n+\"'\");throw l.code=\"MODULE_NOT_FOUND\",l}var u=i[n]={exports:{}};e[n][0].call(u.exports,function(t){return s(e[n][1][t]||t)},u,u.exports,t,e,i,r)}return i[n].exports}for(var o=\"function\"==typeof require&&require,n=0;n<r.length;n++)s(r[n]);return s}return t}()({1:[function(t,e,i){function r(){this.page=-1,this.pages=[],this.newPage()}function s(t,e){this.width=~~t,this.height=~~e,this.transparent=null,this.transIndex=0,this.repeat=-1,this.delay=0,this.image=null,this.pixels=null,this.indexedPixels=null,this.colorDepth=null,this.colorTab=null,this.neuQuant=null,this.usedEntry=new Array,this.palSize=7,this.dispose=-1,this.firstFrame=!0,this.sample=10,this.dither=!1,this.globalPalette=!1,this.out=new r}var o=t(\"./TypedNeuQuant.js\"),n=t(\"./LZWEncoder.js\");r.pageSize=4096,r.charMap={};for(var a=0;a<256;a++)r.charMap[a]=String.fromCharCode(a);r.prototype.newPage=function(){this.pages[++this.page]=new Uint8Array(r.pageSize),this.cursor=0},r.prototype.getData=function(){for(var t=\"\",e=0;e<this.pages.length;e++)for(var i=0;i<r.pageSize;i++)t+=r.charMap[this.pages[e][i]];return t},r.prototype.writeByte=function(t){this.cursor>=r.pageSize&&this.newPage(),this.pages[this.page][this.cursor++]=t},r.prototype.writeUTFBytes=function(t){for(var e=t.length,i=0;i<e;i++)this.writeByte(t.charCodeAt(i))},r.prototype.writeBytes=function(t,e,i){for(var r=i||t.length,s=e||0;s<r;s++)this.writeByte(t[s])},s.prototype.setDelay=function(t){this.delay=Math.round(t/10)},s.prototype.setFrameRate=function(t){this.delay=Math.round(100/t)},s.prototype.setDispose=function(t){t>=0&&(this.dispose=t)},s.prototype.setRepeat=function(t){this.repeat=t},s.prototype.setTransparent=function(t){this.transparent=t},s.prototype.addFrame=function(t){this.image=t,this.colorTab=this.globalPalette&&this.globalPalette.slice?this.globalPalette:null,this.getImagePixels(),this.analyzePixels(),!0===this.globalPalette&&(this.globalPalette=this.colorTab),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.globalPalette||this.writePalette(),this.writePixels(),this.firstFrame=!1},s.prototype.finish=function(){this.out.writeByte(59)},s.prototype.setQuality=function(t){t<1&&(t=1),this.sample=t},s.prototype.setDither=function(t){!0===t&&(t=\"FloydSteinberg\"),this.dither=t},s.prototype.setGlobalPalette=function(t){this.globalPalette=t},s.prototype.getGlobalPalette=function(){return this.globalPalette&&this.globalPalette.slice&&this.globalPalette.slice(0)||this.globalPalette},s.prototype.writeHeader=function(){this.out.writeUTFBytes(\"GIF89a\")},s.prototype.analyzePixels=function(){if(!this.colorTab){var t,e,i,r,s={};for(i=0;i<this.pixels.length;i+=3)t=65536*this.pixels[i]+256*this.pixels[i+1]+this.pixels[i+2],s[t]=(s[t]||0)+1;if(e=Object.keys(s),e.length<256){for(this.colorTab=[],i=0;i<e.length;i++)r=+e[i],this.colorTab.push(parseInt(r/65536)),this.colorTab.push(parseInt(r%65536/256)),this.colorTab.push(r%256);for(i=e.length;i<256;i++)this.colorTab.push(255),this.colorTab.push(255),this.colorTab.push(255)}else this.neuQuant=new o(this.pixels,this.sample),this.neuQuant.buildColormap(),this.colorTab=this.neuQuant.getColormap()}this.dither?this.ditherPixels(this.dither.replace(\"-serpentine\",\"\"),null!==this.dither.match(/-serpentine/)):this.indexPixels(),this.pixels=null,this.colorDepth=8,this.palSize=7,null!==this.transparent&&(this.transIndex=this.findClosest(this.transparent,!0))},s.prototype.indexPixels=function(t){var e=this.pixels.length/3;this.indexedPixels=new Uint8Array(e);for(var i=0,r=0;r<e;r++){var s=this.findClosestRGB(255&this.pixels[i++],255&this.pixels[i++],255&this.pixels[i++]);this.usedEntry[s]=!0,this.indexedPixels[r]=s}},s.prototype.ditherPixels=function(t,e){var i={FalseFloydSteinberg:[[3/8,1,0],[3/8,0,1],[.25,1,1]],FloydSteinberg:[[7/16,1,0],[3/16,-1,1],[5/16,0,1],[1/16,1,1]],Stucki:[[8/42,1,0],[4/42,2,0],[2/42,-2,1],[4/42,-1,1],[8/42,0,1],[4/42,1,1],[2/42,2,1],[1/42,-2,2],[2/42,-1,2],[4/42,0,2],[2/42,1,2],[1/42,2,2]],Atkinson:[[1/8,1,0],[1/8,2,0],[1/8,-1,1],[1/8,0,1],[1/8,1,1],[1/8,0,2]]};if(!t||!i[t])throw\"Unknown dithering kernel: \"+t;var r=i[t],s=0,o=this.height,n=this.width,a=this.pixels,h=e?-1:1;this.indexedPixels=new Uint8Array(this.pixels.length/3);for(var l=0;l<o;l++){e&&(h*=-1);for(var u=1==h?0:n-1,p=1==h?n:0;u!==p;u+=h){s=l*n+u;var f=3*s,c=a[f],y=a[f+1],w=a[f+2];f=this.findClosestRGB(c,y,w),this.usedEntry[f]=!0,this.indexedPixels[s]=f,f*=3;for(var d=this.colorTab[f],g=this.colorTab[f+1],x=this.colorTab[f+2],b=c-d,v=y-g,P=w-x,m=1==h?0:r.length-1,B=1==h?r.length:0;m!==B;m+=h){var T=r[m][1],S=r[m][2];if(T+u>=0&&T+u<n&&S+l>=0&&S+l<o){var F=r[m][0];f=s+T+S*n,f*=3,a[f]=Math.max(0,Math.min(255,a[f]+b*F)),a[f+1]=Math.max(0,Math.min(255,a[f+1]+v*F)),a[f+2]=Math.max(0,Math.min(255,a[f+2]+P*F))}}}}},s.prototype.findClosest=function(t,e){return this.findClosestRGB((16711680&t)>>16,(65280&t)>>8,255&t,e)},s.prototype.findClosestRGB=function(t,e,i,r){if(null===this.colorTab)return-1;for(var s=0,o=16777216,n=this.colorTab.length,a=0,h=0;a<n;h++){var l=t-(255&this.colorTab[a++]),u=e-(255&this.colorTab[a++]),p=i-(255&this.colorTab[a++]),f=l*l+u*u+p*p;(!r||this.usedEntry[h])&&f<o&&(o=f,s=h)}return s},s.prototype.getImagePixels=function(){var t=this.width,e=this.height;this.pixels=new Uint8Array(t*e*3);for(var i=this.image,r=0,s=0,o=0;o<e;o++)for(var n=0;n<t;n++)this.pixels[s++]=i[r++],this.pixels[s++]=i[r++],this.pixels[s++]=i[r++],r++},s.prototype.writeGraphicCtrlExt=function(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);var t,e;null===this.transparent?(t=0,e=0):(t=1,e=2),this.dispose>=0&&(e=7&this.dispose),e<<=2,this.out.writeByte(0|e|t),this.writeShort(this.delay),this.out.writeByte(this.transIndex),this.out.writeByte(0)},s.prototype.writeImageDesc=function(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame||this.globalPalette?this.out.writeByte(0):this.out.writeByte(128|this.palSize)},s.prototype.writeLSD=function(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)},s.prototype.writeNetscapeExt=function(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.out.writeUTFBytes(\"NETSCAPE2.0\"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)},s.prototype.writePalette=function(){this.out.writeBytes(this.colorTab);for(var t=768-this.colorTab.length,e=0;e<t;e++)this.out.writeByte(0)},s.prototype.writeShort=function(t){this.out.writeByte(255&t),this.out.writeByte(t>>8&255)},s.prototype.writePixels=function(){new n(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)},s.prototype.stream=function(){return this.out},e.exports=s},{\"./LZWEncoder.js\":2,\"./TypedNeuQuant.js\":3}],2:[function(t,e,i){function r(t,e,i,r){function h(t,e){T[x++]=t,x>=254&&c(e)}function l(t){u(n),I=P+2,C=!0,d(P,t)}function u(t){for(var e=0;e<t;++e)S[e]=-1}function p(t,e){var i,r,a,h,p,f,c;for(v=t,C=!1,n_bits=v,b=y(n_bits),P=1<<t-1,m=P+1,I=P+2,x=0,h=w(),c=0,i=n;i<65536;i*=2)++c;c=8-c,f=n,u(f),d(P,e);t:for(;(r=w())!=s;)if(i=(r<<o)+h,a=r<<c^h,S[a]!==i){if(S[a]>=0){p=f-a,0===a&&(p=1);do{if((a-=p)<0&&(a+=f),S[a]===i){h=F[a];continue t}}while(S[a]>=0)}d(h,e),h=r,I<1<<o?(F[a]=I++,S[a]=i):l(e)}else h=F[a];d(h,e),d(m,e)}function f(i){i.writeByte(B),remaining=t*e,curPixel=0,p(B+1,i),i.writeByte(0)}function c(t){x>0&&(t.writeByte(x),t.writeBytes(T,0,x),x=0)}function y(t){return(1<<t)-1}function w(){return 0===remaining?s:(--remaining,255&i[curPixel++])}function d(t,e){for(g&=a[M],M>0?g|=t<<M:g=t,M+=n_bits;M>=8;)h(255&g,e),g>>=8,M-=8;if((I>b||C)&&(C?(b=y(n_bits=v),C=!1):(++n_bits,b=n_bits==o?1<<o:y(n_bits))),t==m){for(;M>0;)h(255&g,e),g>>=8,M-=8;c(e)}}var g,x,b,v,P,m,B=Math.max(2,r),T=new Uint8Array(256),S=new Int32Array(n),F=new Int32Array(n),M=0,I=0,C=!1;this.encode=f}var s=-1,o=12,n=5003,a=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535];e.exports=r},{}],3:[function(t,e,i){function r(t,e){function i(){G=[],z=new Int32Array(256),U=new Int32Array(o),_=new Int32Array(o),Q=new Int32Array(o>>3);var t,e;for(t=0;t<o;t++)e=(t<<a+8)/o,G[t]=new Float64Array([e,e,e,0]),_[t]=l/o,U[t]=0}function r(){for(var t=0;t<o;t++)G[t][0]>>=a,G[t][1]>>=a,G[t][2]>>=a,G[t][3]=t}function y(t,e,i,r,s){G[e][0]-=t*(G[e][0]-i)/b,G[e][1]-=t*(G[e][1]-r)/b,G[e][2]-=t*(G[e][2]-s)/b}function d(t,e,i,r,s){for(var n,a,h=Math.abs(e-t),l=Math.min(e+t,o),u=e+1,p=e-1,f=1;u<l||p>h;)a=Q[f++],u<l&&(n=G[u++],n[0]-=a*(n[0]-i)/P,n[1]-=a*(n[1]-r)/P,n[2]-=a*(n[2]-s)/P),p>h&&(n=G[p--],n[0]-=a*(n[0]-i)/P,n[1]-=a*(n[1]-r)/P,n[2]-=a*(n[2]-s)/P)}function M(t,e,i){var r,s,n,l,y,w=~(1<<31),d=w,g=-1,x=g;for(r=0;r<o;r++)s=G[r],n=Math.abs(s[0]-t)+Math.abs(s[1]-e)+Math.abs(s[2]-i),n<w&&(w=n,g=r),l=n-(U[r]>>h-a),l<d&&(d=l,x=r),y=_[r]>>p,_[r]-=y,U[r]+=y<<u;return _[g]+=f,U[g]-=c,x}function I(){var t,e,i,r,s,a,h=0,l=0;for(t=0;t<o;t++){for(i=G[t],s=t,a=i[1],e=t+1;e<o;e++)r=G[e],r[1]<a&&(s=e,a=r[1]);if(r=G[s],t!=s&&(e=r[0],r[0]=i[0],i[0]=e,e=r[1],r[1]=i[1],i[1]=e,e=r[2],r[2]=i[2],i[2]=e,e=r[3],r[3]=i[3],i[3]=e),a!=h){for(z[h]=l+t>>1,e=h+1;e<a;e++)z[e]=t;h=a,l=t}}for(z[h]=l+n>>1,e=h+1;e<256;e++)z[e]=n}function C(t,e,i){for(var r,s,n,a=1e3,h=-1,l=z[e],u=l-1;l<o||u>=0;)l<o&&(s=G[l],n=s[1]-e,n>=a?l=o:(l++,n<0&&(n=-n),r=s[0]-t,r<0&&(r=-r),(n+=r)<a&&(r=s[2]-i,r<0&&(r=-r),(n+=r)<a&&(a=n,h=s[3])))),u>=0&&(s=G[u],n=e-s[1],n>=a?u=-1:(u--,n<0&&(n=-n),r=s[0]-t,r<0&&(r=-r),(n+=r)<a&&(r=s[2]-i,r<0&&(r=-r),(n+=r)<a&&(a=n,h=s[3]))));return h}function A(){var i,r=t.length,o=30+(e-1)/3,n=r/(3*e),h=~~(n/s),l=b,u=g,p=u>>w;for(p<=1&&(p=0),i=0;i<p;i++)Q[i]=l*((p*p-i*i)*v/(p*p));var f;r<F?(e=1,f=3):f=r%m!=0?3*m:r%B!=0?3*B:r%T!=0?3*T:3*S;var c,P,I,C,A=0;for(i=0;i<n;)if(c=(255&t[A])<<a,P=(255&t[A+1])<<a,I=(255&t[A+2])<<a,C=M(c,P,I),y(l,C,c,P,I),0!==p&&d(p,C,c,P,I),A+=f,A>=r&&(A-=r),i++,0===h&&(h=1),i%h==0)for(l-=l/o,u-=u/x,p=u>>w,p<=1&&(p=0),C=0;C<p;C++)Q[C]=l*((p*p-C*C)*v/(p*p))}function D(){i(),A(),r(),I()}function E(){for(var t=[],e=[],i=0;i<o;i++)e[G[i][3]]=i;for(var r=0,s=0;s<o;s++){var n=e[s];t[r++]=G[n][0],t[r++]=G[n][1],t[r++]=G[n][2]}return t}var G,z,U,_,Q;this.buildColormap=D,this.getColormap=E,this.lookupRGB=C}var s=100,o=256,n=o-1,a=4,h=16,l=1<<h,u=10,p=10,f=l>>p,c=l<<u-p,y=o>>3,w=6,d=1<<w,g=y*d,x=30,b=1024,v=256,P=1<<18,m=499,B=491,T=487,S=503,F=3*S;e.exports=r},{}],4:[function(t,e,i){var r,s;r=t(\"./GIFEncoder.js\"),s=function(t){var e,i,s,o;return e=new r(t.width,t.height),0===t.index?e.writeHeader():e.firstFrame=!1,e.setTransparent(t.transparent),e.setDispose(t.dispose),e.setRepeat(t.repeat),e.setDelay(t.delay),e.setQuality(t.quality),e.setDither(t.dither),e.setGlobalPalette(t.globalPalette),e.addFrame(t.data),t.last&&e.finish(),!0===t.globalPalette&&(t.globalPalette=e.getGlobalPalette()),s=e.stream(),t.data=s.pages,t.cursor=s.cursor,t.pageSize=s.constructor.pageSize,t.canTransfer?(o=function(){var e,r,s,o;for(s=t.data,o=[],e=0,r=s.length;e<r;e++)i=s[e],o.push(i.buffer);return o}(),self.postMessage(t,o)):self.postMessage(t)},self.onmessage=function(t){return s(t.data)}},{\"./GIFEncoder.js\":1}]},{},[4]); ";// @plotdb/gif.js/index.js 0.2.0 - https://github.com/plotdb/gif.js
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.GIF=e()}}(function(){return function(){function e(t,n,i){function r(o,a){if(!n[o]){if(!t[o]){var h="function"==typeof require&&require;if(!a&&h)return h(o,!0);if(s)return s(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){return r(t[o][1][e]||e)},f,f.exports,e,t,n,i)}return n[o].exports}for(var s="function"==typeof require&&require,o=0;o<i.length;o++)r(i[o]);return r}return e}()({1:[function(e,t,n){function i(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function r(e){return"function"==typeof e}function s(e){return"number"==typeof e}function o(e){return"object"==typeof e&&null!==e}function a(e){return void 0===e}t.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.prototype.setMaxListeners=function(e){if(!s(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},i.prototype.emit=function(e){var t,n,i,s,h,l;if(this._events||(this._events={}),"error"===e&&(!this._events.error||o(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var f=new Error('Uncaught, unspecified "error" event. ('+t+")");throw f.context=t,f}if(n=this._events[e],a(n))return!1;if(r(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),n.apply(this,s)}else if(o(n))for(s=Array.prototype.slice.call(arguments,1),l=n.slice(),i=l.length,h=0;h<i;h++)l[h].apply(this,s);return!0},i.prototype.addListener=function(e,t){var n;if(!r(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,r(t.listener)?t.listener:t),this._events[e]?o(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,o(this._events[e])&&!this._events[e].warned&&(n=a(this._maxListeners)?i.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},i.prototype.on=i.prototype.addListener,i.prototype.once=function(e,t){function n(){this.removeListener(e,n),i||(i=!0,t.apply(this,arguments))}if(!r(t))throw TypeError("listener must be a function");var i=!1;return n.listener=t,this.on(e,n),this},i.prototype.removeListener=function(e,t){var n,i,s,a;if(!r(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],s=n.length,i=-1,n===t||r(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(o(n)){for(a=s;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){i=a;break}if(i<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},i.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],r(n))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},i.prototype.listeners=function(e){return this._events&&this._events[e]?r(this._events[e])?[this._events[e]]:this._events[e].slice():[]},i.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(r(t))return 1;if(t)return t.length}return 0},i.listenerCount=function(e,t){return e.listenerCount(t)}},{}],2:[function(e,t,n){var i,r,s,o,a;a=navigator.userAgent.toLowerCase(),o=navigator.platform.toLowerCase(),i=a.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],s="ie"===i[1]&&document.documentMode,r={name:"version"===i[1]?i[3]:i[1],version:s||parseFloat("opera"===i[1]&&i[4]?i[4]:i[2]),platform:{name:a.match(/ip(?:ad|od|hone)/)?"ios":(a.match(/(?:webos|android)/)||o.match(/mac|win|linux/)||["other"])[0]}},r[r.name]=!0,r[r.name+parseInt(r.version,10)]=!0,r.platform[r.platform.name]=!0,t.exports=r},{}],3:[function(e,t,n){var i,r,s,o=function(e,t){function n(){this.constructor=e}for(var i in t)a.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},a={}.hasOwnProperty,h=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1},l=[].slice;i=e("events").EventEmitter,s=e("./browser.coffee"),r=function(e){function t(e){var t,i,r;this.running=!1,this.options={},this.frames=[],this.freeWorkers=[],this.activeWorkers=[],this.setOptions(e);for(i in n)r=n[i],null==(t=this.options)[i]&&(t[i]=r)}var n,i,r;return o(t,e),r=URL.createObjectURL(new Blob([GIFWORKER],{type:"application/javascript"})),console.log(r),n={workerScript:r,workers:2,repeat:0,background:"#fff",quality:10,width:null,height:null,transparent:null,debug:!1,dither:!1},i={delay:500,copy:!1,dispose:-1},t.prototype.setOption=function(e,t){if(this.options[e]=t,null!=this._canvas&&("width"===e||"height"===e))return this._canvas[e]=t},t.prototype.setOptions=function(e){var t,n,i;n=[];for(t in e)a.call(e,t)&&(i=e[t],n.push(this.setOption(t,i)));return n},t.prototype.addFrame=function(e,t){var n,r;null==t&&(t={}),n={},n.transparent=this.options.transparent;for(r in i)n[r]=t[r]||i[r];if(null==this.options.width&&this.setOption("width",e.width),null==this.options.height&&this.setOption("height",e.height),"undefined"!=typeof ImageData&&null!==ImageData&&e instanceof ImageData)n.data=e.data;else if("undefined"!=typeof CanvasRenderingContext2D&&null!==CanvasRenderingContext2D&&e instanceof CanvasRenderingContext2D||"undefined"!=typeof WebGLRenderingContext&&null!==WebGLRenderingContext&&e instanceof WebGLRenderingContext)t.copy?n.data=this.getContextData(e):n.context=e;else{if(null==e.childNodes)throw new Error("Invalid image");t.copy?n.data=this.getImageData(e):n.image=e}return this.frames.push(n)},t.prototype.render=function(){var e,t,n,i;if(this.running)throw new Error("Already running");if(null==this.options.width||null==this.options.height)throw new Error("Width and height must be set prior to rendering");if(this.running=!0,this.nextFrame=0,this.finishedFrames=0,this.imageParts=function(){var t,n,i;for(i=[],e=t=0,n=this.frames.length;0<=n?t<n:t>n;e=0<=n?++t:--t)i.push(null);return i}.call(this),n=this.spawnWorkers(),!0===this.options.globalPalette)this.renderNextFrame();else for(e=t=0,i=n;0<=i?t<i:t>i;e=0<=i?++t:--t)this.renderNextFrame();return this.emit("start"),this.emit("progress",0)},t.prototype.abort=function(){for(var e;;){if(null==(e=this.activeWorkers.shift()))break;this.log("killing active worker"),e.terminate()}return this.running=!1,this.emit("abort")},t.prototype.spawnWorkers=function(){var e,t,n;return e=Math.min(this.options.workers,this.frames.length),function(){n=[];for(var i=t=this.freeWorkers.length;t<=e?i<e:i>e;t<=e?i++:i--)n.push(i);return n}.apply(this).forEach(function(e){return function(t){var n;return e.log("spawning worker "+t),n=new Worker(e.options.workerScript),n.onmessage=function(t){return e.activeWorkers.splice(e.activeWorkers.indexOf(n),1),e.freeWorkers.push(n),e.frameFinished(t.data)},e.freeWorkers.push(n)}}(this)),e},t.prototype.frameFinished=function(e){var t,n;if(this.log("frame "+e.index+" finished - "+this.activeWorkers.length+" active"),this.finishedFrames++,this.emit("progress",this.finishedFrames/this.frames.length),this.imageParts[e.index]=e,!0===this.options.globalPalette&&(this.options.globalPalette=e.globalPalette,this.log("global palette analyzed"),this.frames.length>2))for(t=1,n=this.freeWorkers.length;1<=n?t<n:t>n;1<=n?++t:--t)this.renderNextFrame();return h.call(this.imageParts,null)>=0?this.renderNextFrame():this.finishRendering()},t.prototype.finishRendering=function(){var e,t,n,i,r,s,o,a,h,l,f,p,u,c,d,v;for(a=0,c=this.imageParts,r=0,h=c.length;r<h;r++)t=c[r],a+=(t.data.length-1)*t.pageSize+t.cursor;for(a+=t.pageSize-t.cursor,this.log("rendering finished - filesize "+Math.round(a/1e3)+"kb"),e=new Uint8Array(a),p=0,d=this.imageParts,s=0,l=d.length;s<l;s++)for(t=d[s],v=t.data,n=o=0,f=v.length;o<f;n=++o)u=v[n],e.set(u,p),n===t.data.length-1?p+=t.cursor:p+=t.pageSize;return i=new Blob([e],{type:"image/gif"}),this.emit("finished",i,e)},t.prototype.renderNextFrame=function(){var e,t,n;if(0===this.freeWorkers.length)throw new Error("No free workers");if(!(this.nextFrame>=this.frames.length))return e=this.frames[this.nextFrame++],n=this.freeWorkers.shift(),t=this.getTask(e),this.log("starting frame "+(t.index+1)+" of "+this.frames.length),this.activeWorkers.push(n),n.postMessage(t)},t.prototype.getContextData=function(e){return e.getImageData(0,0,this.options.width,this.options.height).data},t.prototype.getImageData=function(e){var t;return null==this._canvas&&(this._canvas=document.createElement("canvas"),this._canvas.width=this.options.width,this._canvas.height=this.options.height),t=this._canvas.getContext("2d"),t.setFill=this.options.background,t.fillRect(0,0,this.options.width,this.options.height),t.drawImage(e,0,0),this.getContextData(t)},t.prototype.getTask=function(e){var t,n;if(t=this.frames.indexOf(e),n={index:t,last:t===this.frames.length-1,delay:e.delay,dispose:e.dispose,transparent:e.transparent,width:this.options.width,height:this.options.height,quality:this.options.quality,dither:this.options.dither,globalPalette:this.options.globalPalette,repeat:this.options.repeat,canTransfer:"chrome"===s.name},null!=e.data)n.data=e.data;else if(null!=e.context)n.data=this.getContextData(e.context);else{if(null==e.image)throw new Error("Invalid frame");n.data=this.getImageData(e.image)}return n},t.prototype.log=function(){var e;if(e=1<=arguments.length?l.call(arguments,0):[],this.options.debug)return console.log.apply(console,e)},t}(i),t.exports=r},{"./browser.coffee":2,events:1}]},{},[3])(3)});
